name: Build and Push Docker Images

on:
  push:
    branches:
      - feature/workflow
      - main

jobs:
  docker:
    runs-on: ubuntu-latest

    steps:
      # 1 Checkout repo
      - name: Checkout code
        uses: actions/checkout@v3

      # 2 Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 3 Log in to Docker Hub using secrets
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4 Build backend Docker image
      - name: Build backend image
        run: |
          docker build -t sudarshan101/my-docker-backend:latest .

      # 5 Build frontend Docker image (corrected path)
      - name: Build frontend image
        run: |
          docker build -f iCinema/frontend/Dockerfile \
            -t sudarshan101/my-docker-frontend:latest ./iCinema/frontend

      # 6 Push backend image
      - name: Push backend image
        run: |
          docker push sudarshan101/my-docker-backend:latest

      # 7 Push frontend image
      - name: Push frontend image
        run: |
          docker push sudarshan101/my-docker-frontend:latest

      # Add SNS notification for failures
      - name: Notify via AWS SNS on failure
        if: failure()  # runs only if any previous step fails
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          SNS_TOPIC_ARN: ${{ secrets.SNS_TOPIC_ARN }}
        run: |
          # Capture the last 50 lines of the GitHub Actions log
          ERROR_LOG=$(tail -n 50 $GITHUB_WORKSPACE/.github/workflows/${GITHUB_WORKFLOW}.log || echo "No log available")

          # Send the message to SNS
          aws sns publish \
            --region $AWS_REGION \
            --topic-arn $SNS_TOPIC_ARN \
            --subject "ðŸš¨ GitHub Actions Failed: $GITHUB_WORKFLOW" \
            --message "Workflow: $GITHUB_WORKFLOW
Branch: $GITHUB_REF
Run ID: $GITHUB_RUN_ID
Repository: $GITHUB_REPOSITORY
Failed step logs: $ERROR_LOG
Check full logs at: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"